<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HFD Pre-Plan</title>
  <link rel="stylesheet" href="css/styles.css" />


  <link rel="icon" href="data:," />
<script>
    // Runtime config
    window.WEBAPP_URL = window.WEBAPP_URL || "https://script.google.com/macros/s/AKfycbw21onFylHT5cxgLf5sZFeivQKL8T80czFd-IJGSJF4hU-08bUM-7Ugje4fg4nMAZnR2A/exec";
    window.GOOGLE_SHEET_JSON_URL = window.GOOGLE_SHEET_JSON_URL || "";
    window.EDIT_SECRET = window.EDIT_SECRET || "changeme";
    
    // --- robust WEBAPP_URL resolution ---
    (function(){
      const qs = new URLSearchParams(location.search);
      const qp = qs.get('webapp');
      if (qp) { try { localStorage.setItem('WEBAPP_URL', qp); } catch(e){} }
      const stored = (function(){ try { return localStorage.getItem('WEBAPP_URL') || ''; } catch(e){ return ''; } })();
      const looksTruncated = (u)=>!u || u.includes('...') || u.length<40;
      const looksWrongOrigin = (u)=>!(/^https:\/\/script\.google\.com\//.test(u) || /^http:\/\/localhost/.test(u));
      if (looksTruncated(window.WEBAPP_URL)) window.WEBAPP_URL = stored || window.WEBAPP_URL;
      if (looksWrongOrigin(window.WEBAPP_URL) && stored) window.WEBAPP_URL = stored;
      if (looksTruncated(window.WEBAPP_URL)) {
        console.error('[config] WEBAPP_URL is missing/invalid. Set it via ?webapp=<url> or localStorage.WEBAPP_URL.');
      } 
      
    })();

    window.__BUILD__ = "popup-edit-2025-10-30T21:03:17";
  </script>
  <style>
    /* Hide any stray main-screen Edit button */
    #btnEdit{ display:none !important; }
    /* Visual hint for locked fields */
    .modal .kv.locked .v{ pointer-events:none; opacity:.8; }
    .modal .kv.locked .k::after{ content:" (locked)"; font-weight:400; opacity:.7; }
  </style>
</head>
<body>

<!-- Password Modal -->
<div id="pwModal" class="pw-modal" hidden>
  <div class="box" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
    <h3 id="pwTitle">Enter Password</h3>
    <p class="muted">Enter your password to make changes.</p>
    <label class="sr-only" for="pwInput">Password</label>
    <input id="pwInput" type="password" autocomplete="current-password" placeholder="Password" />
    <div class="actions">
      <button id="pwCancel" class="btn secondary">Cancel</button>
      <button id="pwOk" class="btn">OK</button>
    </div>
  </div>
</div>

  <!-- Offline banner -->
  <div id="offlineBanner" class="offline-banner" hidden>You're offline — showing last saved data.</div>

  <header class="app-header">
    <div class="brand">HFD Pre-Plan</div>
    <div class="actions">
      <button id="btnAdd" class="btn">Add New</button>
      <!-- Main-screen Edit intentionally removed -->
    </div>
  </header>

  <div class="toolbar">
    <input id="searchInput" class="search" placeholder="Search by name, address, keywords…" />
  </div>

  <section class="card">
    <table id="dataTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="pager">
      <button id="prevPage" class="btn secondary">Prev</button>
      <span id="pageInfo" class="pageinfo"></span>
      <button id="nextPage" class="btn secondary">Next</button>
    </div>
  </section>

  <dialog id="recordModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <div id="modalThumbWrap" class="modal-thumb"></div>
      <h3 id="modalTitle">Record</h3>
      <div class="modal-actions"><span id="editBadge" class="edit-badge" hidden>Editing</span><span id="saveBadge" class="save-badge" hidden>Saved ✓</span><button id="btnModalEdit" class="btn">Edit</button>
      <button id="btnCloseModal" class="btn secondary">Close</button></div>
    </div>
    <div id="sectionNav" class="section-nav"></div>
    <div id="modalContent" class="modal-content"></div>
  </dialog>
  <div id="modalBackdrop" class="modal-backdrop" hidden></div>

  <!-- Shim to neutralize any old bundles that still reference main-screen btnEdit -->
  <script>
    if (typeof window.btnEdit === 'undefined') { 
      window.btnEdit = { addEventListener(){}, set disabled(_){}, get disabled(){ return false; } }; 
    }
  </script>

  <!-- Cache-busted bundle and popup editor -->
<script src="js/popup-edit.js"></script>
<script src="js/app.bundle.js"></script>
<script src="js/hfd-upload-injector.js"></script>


<!-- Tiny hotfix: auto-enter editing for brand-new draft so empty fields are visible -->
<script>
(function(){
  function setup(){
    
    try{
      var m=document.getElementById('recordModal');
      if(m){ if(typeof m.close==='function') m.close(); m.removeAttribute('open'); }
    }catch(_){}
var modal = document.getElementById('recordModal');
    if(!modal) return;
    var obs = new MutationObserver(function(muts){
      if (modal.hasAttribute('open') && (window._isNewDraft === true)) {
        // Defer to allow modal content to render
        requestAnimationFrame(function(){
          var btn = document.getElementById('btnModalEdit');
          if (btn && !modal.classList.contains('editing')) {
            try { btn.click(); } catch(e){ /* noop */ }
          }
        });
      }
    });
    obs.observe(modal, { attributes: true, attributeFilter: ['open'] });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>


<script>
/* Remove any accidental stray '/1' text or elements (enhanced stray /1 scrub) */
(function(){
  try{
    const scan = ()=>{
      document.querySelectorAll('body, body *').forEach(n=>{
        if(n.childNodes) {
          [...n.childNodes].forEach(c=>{
            if((c.nodeType===3 && c.textContent && c.textContent.trim()==='/1') || (c.nodeType===1 && c.childNodes.length===1 && c.textContent && c.textContent.trim()==='/1')){
              c.parentNode.removeChild(c);
            }
          });
        }
      });
    };
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', scan);
    else scan();
  }catch(e){}
})();
</script>

<script>
// Force table refresh if a new draft was opened and then closed without saving
(function(){
  var modal = document.getElementById('recordModal');
  var search = document.getElementById('searchInput');
  if (!modal || !search) return;

  function refreshTableViaSearch(){
    try {
      // Toggle a space to trigger the debounced onSearch in the bundle
      var v = search.value || '';
      search.value = v + ' ';
      search.dispatchEvent(new Event('input', {bubbles:true}));
      setTimeout(function(){
        search.value = v.trim();
        search.dispatchEvent(new Event('input', {bubbles:true}));
      }, 10);
    } catch(e){ /* no-op */ }
  }

  modal.addEventListener('close', function(){
    try {
      if (window._isNewDraft === true) {
        window._isNewDraft = false;
        refreshTableViaSearch();
      }
    } catch(_) {}
  });
})();
</script>


  <script>
    if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/js/sw.js').catch(function(e){ console.warn('SW reg failed', e); });
      });
    }
  </script>

  <script>
    (function(){
      function setState(){
        try{
          var offline = (navigator.onLine === false);
          var b = document.getElementById('offlineBanner');
          if (!b) return;
          b.hidden = !offline;
          document.body.classList.toggle('offline-on', offline);
        }catch(_){}
      }
      window.addEventListener('online', setState);
      window.addEventListener('offline', setState);
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setState);
      } else {
        setState();
      }
      setState();
    })();
  </script>

<script>
// Online/offline banner toggling
(function(){
  function setBanner(show, text){
    try{
      var el = document.getElementById('offlineBanner');
      if (!el) return;
      if (text) el.textContent = text;
      el.hidden = !show;
    }catch(_){}
  }
  function update(){
    if (navigator.onLine === false){
      setBanner(true, "You're offline — showing last saved data.");
    } else {
      // Hide when online; the data-layer may re-show if needed
      setBanner(false);
    }
  }
  window.addEventListener('online', update);
  window.addEventListener('offline', update);
  document.addEventListener('DOMContentLoaded', update);
})();
</script>

</body>
</html>